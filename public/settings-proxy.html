<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title is="chemical-title" data-title-store>Malachite</title>
    <link rel="icon" href="/img/favicon.svg">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/transitions.css">
    <link rel="stylesheet" href="/css/settings.css">
    <link rel="stylesheet" href="/css/modals.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="/js/particles.min.js"></script>
    <script src="/js/particle-configs.js"></script>
    <style>
        /* Fix sidebar positioning to go to top of page */
        .settings-sidebar {
            top: 0 !important;
            margin-top: 0 !important;
        }
        .settings-layout {
            margin-top: 0 !important;
        }
        /* Collapsible group styles */
        .collapsible-group {
            width: 100%;
        }
        .collapsible {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            padding: 14px 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1em;
            transition: background 0.2s;
            border-radius: 8px 8px 0 0;
            margin-top: 10px;
        }
        .collapsible.active, .collapsible:hover {
            background-color: var(--bg-tertiary);
        }
        .collapsible-content {
            padding: 0 18px 10px 18px;
            display: none;
            overflow: hidden;
            background-color: var(--bg-secondary);
            border-radius: 0 0 8px 8px;
        }
        .collapsible-content .setting-card {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="settings-layout">
        <!-- Left Sidebar -->
        <div class="settings-sidebar">
            <div class="sidebar-tabs">
                <div class="tab-item active" data-tab="proxy">
                    <i class="fa-solid fa-network-wired"></i>
                    <span>Proxy</span>
                </div>
                <div class="tab-item" data-tab="security">
                    <i class="fa-solid fa-lock"></i>
                    <span>Security</span>
                </div>
                <div class="tab-item" data-tab="appearance">
                    <i class="fa-solid fa-palette"></i>
                    <span>Appearance</span>
                </div>
                <div class="tab-item" data-tab="misc">
                    <i class="fa-solid fa-cog"></i>
                    <span>Misc</span>
                </div>
            </div>
        </div>
        <!-- Main Content Area -->
        <div class="settings-content">
            <!-- Proxy Settings Tab -->
            <div class="tab-content active" id="proxy">
                <div class="settings-container">
                    <div class="setting-card">
                        <div class="setting-title">Select Transport</div>
                        <div class="setting-description">Select the transport you want the proxy to use.</div>
                        <select id="transport-select" onchange="changeTransport()">
                            <option value="libcurl">Libcurl (Default)</option>
                            <option value="epoxy">Epoxy</option>
                        </select>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">Proxy Backend</div>
                        <div class="setting-description">Choose which proxy backend to use.</div>
                        <select id="proxy-backend-select" onchange="changeProxyBackend()">
                            <option value="uv">Ultraviolet (Default)</option>
                            <option value="rh">Rammerhead</option>
                        </select>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">Select Search Engine</div>
                        <div class="setting-description">Choose which search engine to use.</div>
                        <select id="searchengine-select" onchange="changeSearchEngine()">
                            <option value="duckduckgo">DuckDuckGo (Default)</option>
                            <option value="google">Google</option>
                            <option value="bing">Bing</option>
                            <option value="brave">Brave Search</option>
                            <option value="startpage">Startpage</option>
                            <option value="ecosia">Ecosia</option>
                            <option value="yahoo">Yahoo</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Security Tab -->
            <div class="tab-content" id="security">
                <div class="settings-container">
                    <div class="setting-card">
                        <div class="setting-title">Leave Confirmation</div>
                        <div class="setting-description">Shows a popup when you or another software attempt to close the page.</div>
                        <button class="setting-button" id="leaveconfirmbutton" onclick="leaveconfirmation()">Toggle Leave Confirmation</button>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">Panic Key</div>
                        <div class="setting-description">Choose a key that redirects you to a website when pressed.</div>
                        <button class="setting-button" onclick="openKeybindModal()">Open Panic Key Settings</button>
                    </div>
                </div>
            </div>

            <!-- Appearance Tab -->
            <div class="tab-content" id="appearance">
                <div class="settings-container">
                    <div class="setting-card">
                        <div class="setting-title">Theme</div>
                        <div class="setting-description">Choose your preferred site theme.</div>
                                                    <select id="theme-select" onchange="changeTheme()">
                                <option value="moss">Moss (Default)</option>
                                <option value="midnight">Midnight</option>
                                <option value="rose">Rose</option>
                                <option value="noir">Noir</option>
                                <option value="ocean">Ocean</option>
                                <option value="sunset">Sunset</option>
                                <option value="solar">Solar</option>
                            </select>
                    </div>
                </div>
            </div>

            <!-- Misc Tab -->
            <div class="tab-content" id="misc">
                <div class="settings-container">
                    <div class="setting-card">
                        <div class="setting-title">Change Display Name</div>
                        <div class="setting-description">Change the name displayed in your greeting.</div>
                        <button class="setting-button" onclick="openChangeNameModal()">Change Display Name</button>
                    </div>
                </div>
            </div>

            <!-- Credits Tab -->
            <div class="tab-content" id="credits">
                <div class="settings-container">
                    <div class="setting-card">
                        <div class="setting-title">About Malachite</div>
                        <div class="setting-title" style="font-weight: normal; font-size: medium;">Malachite is a modern web proxy designed for secure and fast browsing. Built with performance and user experience in mind.</div>
                        <div class="setting-title" style="font-weight: normal; font-size: medium;">Current Version: 1.1.0</div>
                        <div class="setting-title" style="font-weight: normal; font-size: medium;">This project is licensed under the AGPL-3.0 License.</div>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">Developers</div>
                        <div class="setting-description">Main Developer</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; justify-content: center;">
                            <a href="https://github.com/cactusflips2020" target="_blank" class="tool-card">
                                <div class="tool-logo">
                                    <img src="img/assets/cactusflips2020.jpg" alt="cactusflips2020" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none;">üë®‚Äçüíª</span>
                                </div>
                                <div class="tool-name">cactusflips2020</div>
                            </a>
                        </div>
                    </div>
                    <div class="setting-card">
                        <div class="setting-title">Tools and Projects</div>
                        <div class="setting-description">Without these Malachite wouldn't of been possible to make.</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; justify-content: center;">
                            <a href="https://github.com/titaniumnetwork-dev/ultraviolet" target="_blank" class="tool-card">
                                <div class="tool-logo">
                                    <img src="img/assets/ultraviolet.webp" alt="Ultraviolet" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none;">üîÆ</span>
                                </div>
                                <div class="tool-name">Ultraviolet</div>
                            </a>
                            <a href="https://github.com/binary-person/rammerhead" target="_blank" class="tool-card">
                                <div class="tool-logo">
                                    <img src="img/assets/rammerhead.png" alt="Rammerhead" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none;">üöÄ</span>
                                </div>
                                <div class="tool-name">Rammerhead</div>
                            </a>
                            <a href="https://github.com/chemicaljs/chemical" target="_blank" class="tool-card">
                                <div class="tool-logo">
                                    <img src="img/assets/chemical.png" alt="ChemicalJS" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none;">üß™</span>
                                </div>
                                <div class="tool-name">ChemicalJS</div>
                            </a>
                            <a href="https://github.com/mercuryworkshop/epoxy-tls" target="_blank" class="tool-card">
                                <div class="tool-logo">
                                    <img src="img/assets/epoxy.webp" alt="Epoxy TLS" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none;">üîó</span>
                                </div>
                                <div class="tool-name">Epoxy TLS</div>
                            </a>
                            <a href="https://github.com/ading2210/libcurl.js" target="_blank" class="tool-card">
                                <div class="tool-logo">
                                    <img src="img/assets/libcurl.webp" alt="libcurl.js" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none;">üåê</span>
                                </div>
                                <div class="tool-name">Libcurl.js</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keybind Modal -->
    <div id="keybind-modal" class="keybind-modal">
        <div id="keybind-particles-js"></div>
        <div class="keybind-content">
            <div class="add-modal-header">
                <h2>Select Panic Key</h2>
                <button class="close-modal" onclick="closeKeybindModal()">&times;</button>
            </div>
            <div class="add-modal-body">
                <div class="form-group">
                    <label>Click the box and press a key. Press Escape to unbind.</label>
                    <div id="keybind-display" class="keybind-box">No key bound</div>
                </div>
                
                <div class="form-group">
                    <label for="keybind-url">Custom Panic URL</label>
                    <input id="keybind-url" class="keybind-url" placeholder="https://www.google.com" />
                </div>
                
                <div class="form-actions">
                    <button id="applykeybindbutton" onclick="applyKeybind()" class="add-btn">Apply</button>
                    <button id="resetkeybindbutton" onclick="resetKeybind()" class="reset-btn">Reset</button>
                    <button onclick="closeKeybindModal()" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>   



    <!-- Change Name Modal -->
    <div class="change-name-modal" id="change-name-modal">
        <div class="change-name-modal-content">
            <div class="add-modal-header">
                <h2>Change Display Name</h2>
                <button class="close-modal" onclick="closeChangeNameModal()">&times;</button>
            </div>
            <div class="add-modal-body">
                <div class="form-group">
                    <label for="change-name-input">Enter your new display name (max 20 characters):</label>
                    <input type="text" id="change-name-input" placeholder="Enter your new name" maxlength="20" />
                </div>
                <div class="form-actions">
                    <button id="applychangenamebutton" onclick="applyChangeName()" class="add-btn">Apply</button>
                    <button onclick="closeChangeNameModal()" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="change-name-notification" class="change-name-notification">
        <span>Changes saved!</span>
    </div>

    <script src="/chemical.js"></script>
    <script src="/chemical.components.js"></script>
    <script src="/chemical.cloaking.js"></script>
    <script src="/js/particles.min.js"></script>
    <script src="/js/settings.js"></script>
    <script>
    // Collapsible group logic: only one open at a time
    document.addEventListener('DOMContentLoaded', function() {
      var collapsibles = document.querySelectorAll('.collapsible-group .collapsible');
      collapsibles.forEach(function(btn, idx) {
        btn.addEventListener('click', function() {
          collapsibles.forEach(function(otherBtn, otherIdx) {
            var content = otherBtn.nextElementSibling;
            if (otherBtn === btn) {
              var isActive = btn.classList.contains('active');
              btn.classList.toggle('active');
              content.style.display = isActive ? 'none' : 'block';
            } else {
              otherBtn.classList.remove('active');
              if (content) content.style.display = 'none';
            }
          });
        });
      });
      
      // Ensure all modals are hidden by default
      const modals = document.querySelectorAll('.keybind-modal, .change-name-modal');
      modals.forEach(modal => {
        modal.classList.remove('show');
      });
      
      // Add click outside to close functionality
      modals.forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.classList.remove('show');
          }
        });
      });
    });
    </script>
    <script>
        // Global function to ensure it's available for onchange events
        window.changeTheme = function() {
            // This will be overridden by the actual function definition below
            console.log('changeTheme called - function not yet defined');
        };

        // Get the current theme
        function getCurrentTheme() {
            return localStorage.getItem('siteTheme') || 'moss';
        }



        // Apply theme immediately when script loads
        (function() {
            const theme = getCurrentTheme();
            document.body.className = `theme-${theme}`;
            
            // Apply theme-specific scrollbar colors
            const root = document.documentElement;
            if (theme === 'moss') {
                root.style.setProperty('--scrollbar-track', '#1a1f1a');
                root.style.setProperty('--scrollbar-thumb', '#384438');
                root.style.setProperty('--scrollbar-thumb-hover', '#4a5a4a');
            } else if (theme === 'midnight') {
                root.style.setProperty('--scrollbar-track', '#151a22');
                root.style.setProperty('--scrollbar-thumb', '#2a3442');
                root.style.setProperty('--scrollbar-thumb-hover', '#3a4452');
            } else if (theme === 'rose') {
                root.style.setProperty('--scrollbar-track', '#1a1114');
                root.style.setProperty('--scrollbar-thumb', '#6e3844');
                root.style.setProperty('--scrollbar-thumb-hover', '#8e4854');
            } else if (theme === 'noir') {
                root.style.setProperty('--scrollbar-track', '#1a1f1a');
                root.style.setProperty('--scrollbar-thumb', '#384438');
                root.style.setProperty('--scrollbar-thumb-hover', '#4a5a4a');
            }
            
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = theme;
            }
        })();





        function loadThemeSetting() {
            const savedTheme = localStorage.getItem('siteTheme') || 'moss';
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = savedTheme;
            }
            
            console.log('Theme dropdown set to:', savedTheme);
        }

        function changeCloak() {
            const selectedCloakOption = document.getElementById('cloak-select').value;
            localStorage.setItem('tabCloak', selectedCloakOption);
            applyCloak(selectedCloakOption);
            console.log(`Saved cloak option: ${selectedCloakOption}`);
            showNotification('Changes saved');
        }

        function applyCloak(option) {
            console.log('Applying cloak:', option);
            
            if (typeof chemical !== 'undefined' && chemical.setStore) {
                console.log('Chemical library found, applying cloak...');
                if (option === 'Google') {
                    chemical.setStore('title', 'Google');
                    chemical.setStore('icon', 'img/google.ico');
                } else if (option === 'Gmail') {
                    chemical.setStore('title', 'Gmail');
                    chemical.setStore('icon', 'img/gmail.ico');
                } else if (option === 'Google Drive') {
                    chemical.setStore('title', 'My Drive - Google Drive');
                    chemical.setStore('icon', 'img/drive.png');
                } else if (option === 'Schoology') {
                    chemical.setStore('title', 'Home | Schoology');
                    chemical.setStore('icon', 'img/schoology.ico');
                } else if (option === 'iReady') {
                    chemical.setStore('title', 'i-Ready Dashboard');
                    chemical.setStore('icon', 'img/iready.ico');
                } else if (option === 'Clever') {
                    chemical.setStore('title', 'Clever | Portal');
                    chemical.setStore('icon', 'img/clever.ico');
                } else {
                    chemical.setStore('title', 'Malachite');
                    chemical.setStore('icon', 'img/favicon.svg');
                }
                console.log('Cloak applied via chemical library');
            } else {
                console.log('Chemical library not available, trying direct DOM manipulation...');
                try {
                    if (option === 'Google') {
                        document.title = 'Google';
                        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                        link.type = 'image/x-icon';
                        link.rel = 'shortcut icon';
                        link.href = '/img/google.ico';
                        document.getElementsByTagName('head')[0].appendChild(link);
                    } else if (option === 'Gmail') {
                        document.title = 'Gmail';
                        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                        link.type = 'image/x-icon';
                        link.rel = 'shortcut icon';
                        link.href = '/img/gmail.ico';
                        document.getElementsByTagName('head')[0].appendChild(link);
                    } else if (option === 'Google Drive') {
                        document.title = 'My Drive - Google Drive';
                        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                        link.type = 'image/x-icon';
                        link.rel = 'shortcut icon';
                        link.href = '/img/drive.png';
                        document.getElementsByTagName('head')[0].appendChild(link);
                    } else if (option === 'Schoology') {
                        document.title = 'Home | Schoology';
                        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                        link.type = 'image/x-icon';
                        link.rel = 'shortcut icon';
                        link.href = '/img/schoology.ico';
                        document.getElementsByTagName('head')[0].appendChild(link);
                    } else if (option === 'iReady') {
                        document.title = 'i-Ready Dashboard';
                        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                        link.type = 'image/x-icon';
                        link.rel = 'shortcut icon';
                        link.href = '/img/iready.ico';
                        document.getElementsByTagName('head')[0].appendChild(link);
                    } else if (option === 'Clever') {
                        document.title = 'Clever | Portal';
                        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                        link.type = 'image/x-icon';
                        link.rel = 'shortcut icon';
                        link.href = '/img/clever.ico';
                        document.getElementsByTagName('head')[0].appendChild(link);
                    } else {
                        document.title = 'Malachite';
                        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                        link.type = 'image/x-icon';
                        link.rel = 'shortcut icon';
                        link.href = '/img/favicon.svg';
                        document.getElementsByTagName('head')[0].appendChild(link);
                    }
                    console.log('Cloak applied via direct DOM manipulation');
                } catch (error) {
                    console.error('Error applying cloak:', error);
                }
            }
            
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'apply-cloak',
                    option: option
                }, '*');
            }
        }

        function loadCloakSetting() {
            const savedCloakOption = localStorage.getItem('tabCloak');
            if (savedCloakOption) {
                const selectElement = document.getElementById('cloak-select');
                if (selectElement) {
                    selectElement.value = savedCloakOption;
                    applyCloak(savedCloakOption);
                }
            } else {
                const selectElement = document.getElementById('cloak-select');
                if (selectElement) {
                    selectElement.value = 'Default';
                    applyCloak('Default');
                }
            }
        }

        window.changeTheme = function() {
            try {
                const themeSelect = document.getElementById('theme-select');
                if (!themeSelect) {
                    console.error('Theme select element not found');
                    return;
                }
                
                const selectedTheme = themeSelect.value;
                console.log(`Theme changed to: ${selectedTheme}`);
                
                document.body.classList.remove('theme-moss', 'theme-midnight', 'theme-rose', 'theme-noir');
                document.body.classList.add('theme-' + selectedTheme);
                localStorage.setItem('siteTheme', selectedTheme);
                
                const root = document.documentElement;
                if (selectedTheme === 'moss') {
                    root.style.setProperty('--scrollbar-track', '#1a1f1a');
                    root.style.setProperty('--scrollbar-thumb', '#384438');
                    root.style.setProperty('--scrollbar-thumb-hover', '#4a5a4a');
                } else if (selectedTheme === 'midnight') {
                    root.style.setProperty('--scrollbar-track', '#151a22');
                    root.style.setProperty('--scrollbar-thumb', '#2a3442');
                    root.style.setProperty('--scrollbar-thumb-hover', '#3a4452');
                } else if (selectedTheme === 'rose') {
                    root.style.setProperty('--scrollbar-track', '#1a1114');
                    root.style.setProperty('--scrollbar-thumb', '#6e3844');
                    root.style.setProperty('--scrollbar-thumb-hover', '#8e4854');
                } else if (selectedTheme === 'noir') {
                    root.style.setProperty('--scrollbar-track', '#1a1f1a');
                    root.style.setProperty('--scrollbar-thumb', '#384438');
                    root.style.setProperty('--scrollbar-thumb-hover', '#4a5a4a');
                }
                
                if (typeof updateNotificationThemes === 'function') {
                    updateNotificationThemes(selectedTheme);
                }
                
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'theme-change',
                        theme: selectedTheme
                    }, '*');
                }
                
                if (typeof showNotification === 'function') {
                    showNotification('Theme changed');
                }
                console.log('Theme change completed successfully');
            } catch (error) {
                console.error('Error in changeTheme function:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Theme change error - check console');
                }
            }
        }

        function loadSavedValues() {
            const savedTransport = localStorage.getItem('transportSelect');
            if (savedTransport) {
                const transportSelect = document.getElementById('transport-select');
                if (transportSelect) {
                    transportSelect.value = savedTransport;
                    applyTransport(savedTransport);
                }
            }
            
            loadCloakSetting();
            
            const savedSearchEngine = localStorage.getItem('searchEngineSelect');
            if (savedSearchEngine) {
                const searchEngineSelect = document.getElementById('searchengine-select');
                if (searchEngineSelect) {
                    searchEngineSelect.value = savedSearchEngine;
                    applySearchEngine(savedSearchEngine);
                }
            }

            const savedProxyBackend = localStorage.getItem('proxyBackendSelect');
            if (savedProxyBackend) {
                const proxyBackendSelect = document.getElementById('proxy-backend-select');
                if (proxyBackendSelect) {
                    proxyBackendSelect.value = savedProxyBackend;
                    applyProxyBackend(savedProxyBackend);
                }
            }
            
            const savedTheme = localStorage.getItem('siteTheme');
            if (savedTheme) {
                const themeSelect = document.getElementById('theme-select');
                if (themeSelect) {
                    themeSelect.value = savedTheme;
                }
            }
            
            const leaveConfirmation = localStorage.getItem('leaveConfirmation');
            if (leaveConfirmation === 'true') {
                const leaveConfirmButton = document.getElementById('leaveconfirmbutton');
                if (leaveConfirmButton) {
                    leaveConfirmButton.textContent = 'Disable Leave Confirmation';
                }
            }
        }

        function changeTransport() {
            const selectedTransport = document.getElementById('transport-select').value;
            console.log(`Transport changed to: ${selectedTransport}`);
            localStorage.setItem('transportSelect', selectedTransport);
            applyTransport(selectedTransport);
            
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'transport-change',
                    transport: selectedTransport
                }, '*');
            }
            
            showNotification('Changes saved');
        }

        function applyTransport(transport) {
            console.log('Applying transport:', transport);
        }

        function changeProxyBackend() {
            const selectedBackend = document.getElementById('proxy-backend-select').value;
            console.log(`Proxy backend changed to: ${selectedBackend}`);
            localStorage.setItem('proxyBackendSelect', selectedBackend);
            applyProxyBackend(selectedBackend);
            
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'proxy-backend-change',
                    backend: selectedBackend
                }, '*');
            }
            
            showNotification('Changes saved');
        }

        function applyProxyBackend(backend) {
            console.log('Applying proxy backend:', backend);
        }

        function changeSearchEngine() {
            const selectedEngine = document.getElementById('searchengine-select').value;
            console.log(`Search engine changed to: ${selectedEngine}`);
            localStorage.setItem('searchEngineSelect', selectedEngine);
            applySearchEngine(selectedEngine);
            
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'search-engine-change',
                    engine: selectedEngine
                }, '*');
            }
            
            showNotification('Changes saved');
        }

        function applySearchEngine(engine) {    
            console.log('Applying search engine:', engine);
        }

        function leaveconfirmation() {
            const button = document.getElementById('leaveconfirmbutton');
            const currentState = localStorage.getItem('leaveConfirmation') === 'true';
            const newState = !currentState;
            
            localStorage.setItem('leaveConfirmation', newState.toString());
            
            updateLeaveConfirmButton();
            
            showNotification('Changes saved');
            
            // Send message to parent
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'leave-confirmation-change',
                    enabled: newState
                }, '*');
            }
        }
        
        // Function to update leave confirmation button appearance
        function updateLeaveConfirmButton() {
            const button = document.getElementById('leaveconfirmbutton');
            const isLeaveConfirmationEnabled = localStorage.getItem('leaveConfirmation') === 'true';
            
            if (button) {
                if (isLeaveConfirmationEnabled) {
                    button.textContent = 'Leave Confirmation: ON';
                } else {
                    button.textContent = 'Leave Confirmation: OFF';
                }
            }
        }

        let notifications = [];

        // Notification function
        function showNotification(message) {
            // Play notification sound
            let audio = new Audio("/audio/notification.mp3");
            audio.play().catch(error => console.warn("Audio play failed:", error));

            let notification = document.createElement("div");
            const theme = localStorage.getItem('siteTheme') || 'moss';
            notification.className = "notification theme-" + theme;
            notification.innerText = message;
            
            // Set background, text, and border color using CSS variables
            notification.style.background = 'var(--bg-secondary)';
            notification.style.color = 'var(--text-primary)';
            notification.style.border = '1.5px solid var(--border-primary)';

            // Style the notification
            Object.assign(notification.style, {
                position: "fixed",
                bottom: "20px",
                right: "20px",
                padding: "10px 15px",
                borderRadius: "5px",
                boxShadow: "0 2px 10px rgba(0,0,0,0.3)",
                zIndex: "1000",
                fontSize: "14px",
                opacity: "1",
                transition: "opacity 0.5s ease-in-out, transform 0.3s ease-in-out",
            });

            document.body.appendChild(notification);
            notifications.push(notification);

            // Adjust position of all notifications
            notifications.forEach((notif, index) => {
                notif.style.bottom = `${20 + (notifications.length - 1 - index) * 50}px`;
            });

            // If more than 3 notifications, remove the top (oldest) one
            if (notifications.length > 3) {
                let oldest = notifications.shift();
                oldest.style.opacity = "0";
                oldest.style.transform = "translateY(-20px)";
                setTimeout(() => oldest.remove(), 500);
            }

            // Remove this notification after 3 seconds
            setTimeout(() => {
                if (notifications.includes(notification)) {
                    notifications = notifications.filter(n => n !== notification);
                    notification.style.opacity = "0";
                    notification.style.transform = "translateY(-20px)";
                    setTimeout(() => notification.remove(), 500);
                }
            }, 3000);
        }

        // Initialize particles.js for modals
        function initParticles() {
            try {
                if (typeof particlesJS !== 'undefined') {
                    // Check if containers exist before initializing
                    const keybindContainer = document.getElementById('keybind-particles-js');
                    
                    // Initialize particles for keybind modal only if container exists
                    if (keybindContainer) {
                        particlesJS('keybind-particles-js', getParticleConfig());
                    }
                }
            } catch (error) {
                console.warn('Particles initialization error:', error);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved values and theme
            loadSavedValues();
            loadThemeSetting();
            initParticles();
            
            // Initialize main background particles
            if (typeof initMainBackgroundParticles === 'function') {
                initMainBackgroundParticles();
            }
            
            // Update leave confirmation button
            updateLeaveConfirmButton();
        });

        // Function to update existing notifications to match new theme
        function updateNotificationThemes(theme) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.className = 'notification theme-' + theme;
                
                // Update inline styles using CSS variables
                notification.style.background = 'var(--bg-secondary)';
                notification.style.color = 'var(--text-primary)';
                notification.style.border = '1.5px solid var(--border-primary)';
            });
        }

        // Listen for theme changes from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'theme-change') {
                const theme = event.data.theme;
                document.body.classList.remove('theme-moss', 'theme-midnight', 'theme-rose', 'theme-noir');
                document.body.classList.add('theme-' + theme);
                localStorage.setItem('siteTheme', theme);
                
                // Apply theme-specific scrollbar colors using CSS variables from themes.css
                const style = getComputedStyle(document.body);
                const root = document.documentElement;
                root.style.setProperty('--scrollbar-track', style.getPropertyValue('--scrollbar-track').trim());
                root.style.setProperty('--scrollbar-thumb', style.getPropertyValue('--scrollbar-thumb').trim());
                root.style.setProperty('--scrollbar-thumb-hover', style.getPropertyValue('--scrollbar-thumb-hover').trim());
            }
        });

        // ===== MODAL FUNCTIONS =====
        
        // Keybind Modal Functions
        function openKeybindModal() {
            console.log('Opening keybind modal...');
            const modal = document.getElementById('keybind-modal');
            modal.style.display = 'flex';
            modal.classList.add('show');
            loadKeybindSetting();
            
            // Initialize particles for keybind modal with full background coverage
            const currentTheme = getCurrentTheme();
            setTimeout(() => {
                // Use centralized config with theme CSS variables
                if (typeof particlesJS !== 'undefined') {
                    const keybindContainer = document.getElementById('keybind-particles-js');
                    if (keybindContainer) {
                        particlesJS('keybind-particles-js', getParticleConfig());
                    }
                }
            }, 50);
        }
        
        function closeKeybindModal() {
            const modal = document.getElementById('keybind-modal');
            modal.classList.remove('show');
            modal.style.display = 'none';
            
            // Clean up particles
            if (typeof pJSDom !== 'undefined' && pJSDom.length > 0) {
                for (let i = pJSDom.length - 1; i >= 0; i--) {
                    if (pJSDom[i].pJS && pJSDom[i].pJS.canvas && pJSDom[i].pJS.canvas.el && 
                        pJSDom[i].pJS.canvas.el.id === 'keybind-particles-js') {
                        pJSDom[i].pJS.fn.vendors.destroypJS();
                        pJSDom.splice(i, 1);
                        break;
                    }
                }
            }
        }
        
        function loadKeybindSetting() {
            const savedKey = localStorage.getItem('redirectKey');
            const savedUrl = localStorage.getItem('redirectUrl');
            const keybindDisplay = document.getElementById('keybind-display');
            const keybindUrl = document.getElementById('keybind-url');
            
            if (savedKey) {
                keybindDisplay.textContent = `Key: ${savedKey}`;
            } else {
                keybindDisplay.textContent = 'No key bound';
            }
            
            if (savedUrl) {
                keybindUrl.value = savedUrl;
            } else {
                keybindUrl.value = 'https://www.google.com';
            }
            
            // Add keydown event listener for key binding
            keybindDisplay.addEventListener('click', function() {
                keybindDisplay.textContent = 'Press a key...';
                keybindDisplay.style.borderColor = '#b2c2a8';
                
                function handleKeydown(e) {
                    e.preventDefault();
                    if (e.key === 'Escape') {
                        keybindDisplay.textContent = 'No key bound';
                        keybindDisplay.style.borderColor = '#384438';
                        document.removeEventListener('keydown', handleKeydown);
                        return;
                    }
                    
                    keybindDisplay.textContent = `Key: ${e.key}`;
                    keybindDisplay.style.borderColor = '#384438';
                    document.removeEventListener('keydown', handleKeydown);
                }
                
                document.addEventListener('keydown', handleKeydown);
            });
        }
        
        function applyKeybind() {
            const keybindDisplay = document.getElementById('keybind-display');
            const keybindUrl = document.getElementById('keybind-url');
            
            if (keybindDisplay.textContent !== 'No key bound') {
                const key = keybindDisplay.textContent.replace('Key: ', '');
                localStorage.setItem('redirectKey', key);
                localStorage.setItem('redirectUrl', keybindUrl.value);
                showNotification('Changes saved');
                closeKeybindModal();
            } else {
                alert('Please bind a key first!');
            }
        }
        
        function resetKeybind() {
            localStorage.removeItem('redirectKey');
            localStorage.removeItem('redirectUrl');
            document.getElementById('keybind-display').textContent = 'No key bound';
            document.getElementById('keybind-url').value = 'https://www.google.com';
            showNotification('Changes saved');
        }
        
        // Change Name Modal Functions
        function openChangeNameModal() {
            console.log('Opening change name modal...');
            const modal = document.getElementById('change-name-modal');
            modal.style.display = 'flex';
            modal.classList.add('show');
            const currentName = localStorage.getItem('userName') || '';
            document.getElementById('change-name-input').value = currentName;
        }
        
        function closeChangeNameModal() {
            const modal = document.getElementById('change-name-modal');
            modal.classList.remove('show');
            modal.style.display = 'none';
            document.getElementById('change-name-input').value = '';
        }
        
        function applyChangeName() {
            const newName = document.getElementById('change-name-input').value.trim();
            if (newName) {
                localStorage.setItem('userName', newName);
                showNotification('Changes saved');
                closeChangeNameModal();
            } else {
                alert('Please enter a name!');
            }
        }

        // Load settings on page load
        window.addEventListener('load', function() {
            // Theme is already loaded in DOMContentLoaded
        });



    </script>
    <script>
    // Sidebar tab switching logic
    document.addEventListener('DOMContentLoaded', function() {
      const tabItems = document.querySelectorAll('.tab-item');
      const tabContents = document.querySelectorAll('.tab-content');
      tabItems.forEach(tab => {
        tab.addEventListener('click', function() {
          const targetTab = this.getAttribute('data-tab');
          // Remove active class from all tabs and contents
          tabItems.forEach(item => item.classList.remove('active'));
          tabContents.forEach(content => {
            content.classList.remove('active');
            content.style.display = 'none';
          });
          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          const targetContent = document.getElementById(targetTab);
          if (targetContent) {
            targetContent.style.display = 'block';
            targetContent.classList.add('active');
          }
        });
      });
      // Show the first tab by default
      const firstTab = document.querySelector('.tab-item');
      const firstContent = document.querySelector('.tab-content');
      if (firstTab && firstContent) {
        firstTab.classList.add('active');
        firstContent.style.display = 'block';
        firstContent.classList.add('active');
      }
    });
    </script>
    
    <!-- Particles initialization script -->
    <script>
        // Initialize main background particles
        function initMainBackgroundParticles() {
            const theme = localStorage.getItem('siteTheme') || 'moss';
            const config = getParticleConfig(); // Use centralized config
            
            // Check if particles are already initialized
            if (typeof pJSDom !== 'undefined' && pJSDom.length > 0) {
                for (let i = 0; i < pJSDom.length; i++) {
                    if (pJSDom[i].pJS && pJSDom[i].pJS.canvas && pJSDom[i].pJS.canvas.el && 
                        pJSDom[i].pJS.canvas.el.id === 'particles-js') {
                        pJSDom[i].pJS.fn.vendors.destroypJS();
                        pJSDom.splice(i, 1);
                        break;
                    }
                }
            }
            
            if (typeof particlesJS !== 'undefined') {
                try {
                    particlesJS('particles-js', config);
                } catch (error) {
                    console.error('Error initializing particles:', error);
                }
            }
        }

        // Initialize particles when page loads
        window.addEventListener('load', function() {
            initMainBackgroundParticles();
        });

        // Reinitialize particles when theme changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'siteTheme') {
                setTimeout(initMainBackgroundParticles, 100);
            }
        });
    </script>
</body>
</html> 