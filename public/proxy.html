<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title is="chemical-title" data-title-store>Malachite</title>
    <link rel="icon" is="chemical-icon" data-icon-store href="img/favicon.ico">
    <link rel="stylesheet" href="css/proxy.css">
    <link rel="stylesheet" href="css/transitions.css">
    
    <!-- Preload optimizations for faster iframe loading -->
    <link rel="preload" as="document" href="about:blank">
    <link rel="dns-prefetch" href="//www.google.com">
    <link rel="dns-prefetch" href="//www.bing.com">
    <link rel="dns-prefetch" href="//www.youtube.com">
    <link rel="dns-prefetch" href="//www.github.com">
    <link rel="dns-prefetch" href="//www.reddit.com">
    <link rel="dns-prefetch" href="//www.twitter.com">
    <link rel="dns-prefetch" href="//www.facebook.com">
    <link rel="dns-prefetch" href="//www.instagram.com">
    <link rel="dns-prefetch" href="//www.discord.com">
    <link rel="dns-prefetch" href="//www.netflix.com">
    <link rel="dns-prefetch" href="//www.spotify.com">
    <link rel="dns-prefetch" href="//www.twitch.tv">
    <link rel="dns-prefetch" href="//www.amazon.com">
    <link rel="dns-prefetch" href="//www.wikipedia.org">
    <link rel="dns-prefetch" href="//www.stackoverflow.com">
    <link rel="dns-prefetch" href="//www.github.com">
    <link rel="dns-prefetch" href="//www.cloudflare.com">
    <link rel="dns-prefetch" href="//www.jsdelivr.net">
    <link rel="dns-prefetch" href="//www.cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//www.unpkg.com">
    <link rel="dns-prefetch" href="//www.cdn.jsdelivr.net">
    
    <!-- Chemical.js Proxy Framework -->
    <script src="/chemical.js"></script>
    <script src="/chemical.components.js"></script>
    <script src="/chemical.cloaking.js"></script>
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- Eruda DevTools for debugging -->
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        // Initialize Eruda but keep it hidden initially
        eruda.init();
        eruda.get('entryBtn').hide(); // Hide the entry button using Eruda's API
        
        // Function to show devtools when proxy is loaded
        function showDevTools() {
            console.log('Showing Eruda devtools after proxy load...');
            const erudaButton = document.querySelector('.eruda-launcher');
            if (erudaButton) {
                erudaButton.style.display = 'block';
                erudaButton.style.visibility = 'visible';
                erudaButton.style.opacity = '1';
                erudaButton.style.pointerEvents = 'auto';
                erudaButton.style.zIndex = '2147483646';
                console.log('Eruda button should now be visible');
            } else {
                console.log('Eruda button not found, trying alternative selector...');
                // Try alternative selectors
                const alternativeButtons = document.querySelectorAll('[class*="eruda"], [id*="eruda"]');
                console.log('Found alternative eruda elements:', alternativeButtons.length);
                alternativeButtons.forEach(btn => {
                    btn.style.display = 'block';
                    btn.style.visibility = 'visible';
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                    btn.style.zIndex = '2147483646';
                });
            }
        }
        
        // Function to hide devtools initially
        function hideDevTools() {
            const erudaButton = document.querySelector('.eruda-launcher');
            if (erudaButton) {
                erudaButton.style.display = 'none';
                erudaButton.style.visibility = 'hidden';
                erudaButton.style.opacity = '0';
                erudaButton.style.pointerEvents = 'none';
            }
            
            // Also hide any other eruda elements
            const alternativeButtons = document.querySelectorAll('[class*="eruda"], [id*="eruda"]');
            alternativeButtons.forEach(btn => {
                btn.style.display = 'none';
                btn.style.visibility = 'hidden';
                btn.style.opacity = '0';
                btn.style.pointerEvents = 'none';
            });
        }
        
        // Hide devtools initially
        hideDevTools();
        
        // Keep hiding the button periodically until proxy loads
        const hideInterval = setInterval(hideDevTools, 500);
        
        // Make showDevTools function globally available for proxypage.js
        window.showDevTools = showDevTools;
        window.hideDevTools = hideDevTools;
        window.clearHideInterval = function() {
            clearInterval(hideInterval);
        };
        
        // Manual theme testing function (can be called from browser console)
        window.testScrollbarTheme = function(theme) {
            console.log('Manually testing scrollbar theme:', theme);
            document.body.classList.remove('theme-moss', 'theme-midnight', 'theme-solarized', 'theme-rose', 'theme-noir');
            document.body.classList.add('theme-' + theme);
            
            // Apply theme-specific scrollbar colors
            const root = document.documentElement;
            if (theme === 'moss') {
                root.style.setProperty('--scrollbar-track', '#1a1f1a');
                root.style.setProperty('--scrollbar-thumb', '#384438');
                root.style.setProperty('--scrollbar-thumb-hover', '#4a5a4a');
            } else if (theme === 'midnight') {
                root.style.setProperty('--scrollbar-track', '#151a22');
                root.style.setProperty('--scrollbar-thumb', '#2a3442');
                root.style.setProperty('--scrollbar-thumb-hover', '#3a4452');
            } else if (theme === 'rose') {
                root.style.setProperty('--scrollbar-track', '#1a1114');
                root.style.setProperty('--scrollbar-thumb', '#6e3844');
                root.style.setProperty('--scrollbar-thumb-hover', '#8e4854');
            } else if (theme === 'noir') {
                root.style.setProperty('--scrollbar-track', '#1a1f1a');
                root.style.setProperty('--scrollbar-thumb', '#384438');
                root.style.setProperty('--scrollbar-thumb-hover', '#4a5a4a');
            }
            
            // Force a repaint to ensure the scrollbar updates
            const tabsContainer = document.getElementById('tabs-container');
            if (tabsContainer) {
                console.log('Found tabs container, forcing repaint...');
                tabsContainer.style.display = 'none';
                tabsContainer.offsetHeight; // Force reflow
                tabsContainer.style.display = '';
                
                // Also try forcing the scrollbar to update by temporarily changing overflow
                tabsContainer.style.overflowX = 'hidden';
                setTimeout(() => {
                    tabsContainer.style.overflowX = 'auto';
                }, 10);
            } else {
                console.log('Tabs container not found!');
            }
            
            // Log current CSS variable values
            console.log('Current CSS variables:');
            console.log('--scrollbar-track:', getComputedStyle(root).getPropertyValue('--scrollbar-track'));
            console.log('--scrollbar-thumb:', getComputedStyle(root).getPropertyValue('--scrollbar-thumb'));
            console.log('--scrollbar-thumb-hover:', getComputedStyle(root).getPropertyValue('--scrollbar-thumb-hover'));
            
            // Check if scrollbar elements exist and their computed styles
            setTimeout(() => {
                const scrollbarTrack = document.querySelector('#tabs-container::-webkit-scrollbar-track');
                const scrollbarThumb = document.querySelector('#tabs-container::-webkit-scrollbar-thumb');
                console.log('Scrollbar elements found:', { track: scrollbarTrack, thumb: scrollbarThumb });
                
                // Try to directly set styles on the scrollbar elements
                const style = document.createElement('style');
                style.textContent = `
                    #tabs-container::-webkit-scrollbar-track {
                        background: ${getComputedStyle(root).getPropertyValue('--scrollbar-track')} !important;
                    }
                    #tabs-container::-webkit-scrollbar-thumb {
                        background: ${getComputedStyle(root).getPropertyValue('--scrollbar-thumb')} !important;
                    }
                    #tabs-container::-webkit-scrollbar-thumb:hover {
                        background: ${getComputedStyle(root).getPropertyValue('--scrollbar-thumb-hover')} !important;
                    }
                `;
                document.head.appendChild(style);
                console.log('Added inline styles for scrollbar');
            }, 100);
        };
    </script>
</head>
<body>
    <script>
        // Redirect to index if user is logged in but has no name set
        (function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userName = localStorage.getItem('userName');
            if (isLoggedIn === 'true' && !userName) {
                window.location.href = 'index.html';
            }
        })();
    </script>
    <div id="particles-js"></div>
    <!-- Loading Screen - Shows while proxy initializes -->
    <div class="loading-screen">
        <div id="loading-particles-js"></div>
        <div class="loading-wheel"></div>
        <br>
        <div class="loading-text" id="loadingText">Loading Proxy...</div>
    </div>
    
    <!-- Navigation Bar -->
    <div id="navbar">
        <!-- Logo and Home Link -->
        <a href="index.html" id="logo-container">
            <img src="/img/logo.png" alt="Logo" id="logo" />
            <span id="logo-text">Malachite</span>
        </a>
        
        <!-- URL Search Input -->
        <input
            autofocus
            spellcheck="false"
            autocomplete="off"
            id="proxySearch" 
            placeholder="Search or Enter a URL"
            is="chemical-input"
        />
        
        <!-- Navigation Controls -->
        <section id="controls">
            <button onclick="chemical.componentAction('back', 'proxyIframe')">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <button onclick="chemical.componentAction('forward', 'proxyIframe')">
                <i class="fa-solid fa-arrow-right"></i>
            </button>
            <button onclick="chemical.componentAction('reload', 'proxyIframe')">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button onclick="openInNewTab()" title="Open in New Tab">
                <i class="fa-solid fa-external-link-alt"></i>
            </button>
            <button onclick="showSettingsPage()" title="Settings">
                <i class="fa-solid fa-gear"></i>
            </button>
            <button onclick="toggleFullscreen()" id="fullscreenBtn">
                <i class="fa-solid fa-expand" id="fullscreenIcon"></i>
            </button>
            <button onclick="toggleErudaDevtools()" id="devtoolsBtn" title="Toggle Devtools">
                <i class="fa-solid fa-code"></i>
            </button>
        </section>
    </div>
    
    <!-- Proxy Iframe - Displays the proxied website -->
    <iframe 
        id="proxyIframe" 
        src="about:blank"
        loading="eager"
        importance="high"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-presentation allow-top-navigation"
    ></iframe>
    
    <!-- Tab Bar -->
    <div id="tab-bar">
        <div id="tabs-container">
            <!-- Tabs will be dynamically added here -->
        </div>
        <button id="add-tab-btn" class="add-tab" onclick="addNewTab()">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>
    
    <!-- Homepage Overlay -->
    <div id="homepage-overlay" class="homepage-overlay">
        <div class="logo-above-title slide-in-element" style="opacity: 0; transform: translateY(-30px);">
            <div style="text-align: center; margin-bottom: 2px;">
                <span id="proxy-main-time" style="font-size: 5.5em; font-weight: bold; line-height: 1;"></span>
            </div>
            <span id="proxy-main-date" style="font-size: 1em; display: block; margin-bottom: 5px;"></span>
            <span id="proxy-main-greeting" style="font-size: 1.1em; font-style: italic; display: block; margin-bottom: 20px;"></span>
        </div>
        
        <input
            autofocus
            spellcheck="false"
            autocomplete="off"
            id="homepage-search"
            data-auto-https
            data-search-engine="https://www.google.com/search?q=%s"
            placeholder="Search or Enter a URL"
            is="chemical-input"
            class="slide-in-element"
            style="opacity: 0; transform: translateY(-30px);"
        />
        
        <div id="proxy-latency-fps-widget" class="widget-container slide-in-element" style="opacity: 0; transform: translateY(-30px);">
            Ping: <span id="proxy-latency-value">Fetching Ping...</span> | 
            FPS: <span id="proxy-fps-value">0</span>
        </div>
        <!-- Custom Buttons Container: always visible under FPS/Ping widget -->
        <div id="custom-buttons-container" class="custom-buttons-container slide-in-element" style="opacity: 0; transform: translateY(-30px);">
            <!-- Custom buttons will be dynamically added here -->
        </div>
    </div>
    
    <!-- Add Custom Button Modal -->
    <div id="add-button-modal" class="add-button-modal">
        <div class="add-button-modal-content">
            <div class="add-button-modal-header">
                <h2>Add Custom Button</h2>
                <button class="close-modal" onclick="closeAddButtonModal()">&times;</button>
            </div>
            <div class="add-button-modal-body">
                <div class="form-group">
                    <label for="button-name">Button Name:</label>
                    <input type="text" id="button-name" placeholder="Enter button name" />
                </div>
                <div class="form-group">
                    <label for="button-link">URL:</label>
                    <input type="url" id="button-link" placeholder="https://example.com" />
                </div>
                <div class="form-group">
                    <label for="button-icon">Icon (FontAwesome class):</label>
                    <input type="text" id="button-icon" placeholder="fa-solid fa-link" />
                </div>
                <div class="form-actions">
                    <button onclick="addCustomButton()" class="add-btn">Add Button</button>
                    <button onclick="closeAddButtonModal()" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Manage Custom Buttons Modal -->
    <div id="manage-buttons-modal" class="manage-buttons-modal">
        <div class="manage-buttons-modal-content">
            <div class="manage-buttons-modal-header">
                <h2>Manage Custom Buttons</h2>
                <button class="close-modal" onclick="closeManageButtonsModal()">&times;</button>
            </div>
            <div class="manage-buttons-modal-body">
                <div id="custom-buttons-list">
                    <!-- Custom buttons will be listed here -->
                </div>
            </div>
        </div>
    </div>


    <!-- Main JavaScript -->
    <script>
        // ===== LOADING SCREEN FUNCTIONALITY =====
        
        // Array of loading messages to display randomly
        const loadingMessages = [
            "Loading Proxy...",
            "Connecting to Server...",
            "Initializing Proxy..."
        ];

        // Display random loading message on page load
        document.addEventListener('DOMContentLoaded', function() {
            const loadingTextElement = document.getElementById('loadingText');
            if (loadingTextElement) {
                const randomIndex = Math.floor(Math.random() * loadingMessages.length);
                loadingTextElement.textContent = loadingMessages[randomIndex];
            }
        });

        // ===== LOADING SCREEN PARTICLES =====
        
        // Theme-based particle configurations for loading screen
        const loadingParticleConfigs = {
            moss: {
                particles: {
                    number: { value: 30, density: { enable: true, value_area: 800 } },
                    color: { value: ['#b2c2a8', '#94e2d5', '#a6e3a1', '#89dceb'] },
                    shape: { type: 'circle' },
                    opacity: { value: 0.4, random: true, anim: { enable: false, speed: 1, opacity_min: 0.2, sync: false } },
                    size: { value: 2.5, random: true, anim: { enable: false, speed: 2, size_min: 1, sync: false } },
                    line_linked: { enable: true, distance: 180, color: '#b2c2a8', opacity: 0.3, width: 0.5 },
                    move: { enable: true, speed: 2, direction: 'none', random: true, straight: false, out_mode: 'bounce', bounce: true, attract: { enable: false, rotateX: 600, rotateY: 1200 } }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: {
                        onhover: { enable: false, mode: 'repulse' },
                        onclick: { enable: false, mode: 'push' },
                        resize: true
                    },
                    modes: {
                        grab: { distance: 140, line_linked: { opacity: 1 } },
                        bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 },
                        repulse: { distance: 150, duration: 0.4 },
                        push: { particles_nb: 4 },
                        remove: { particles_nb: 2 }
                    }
                },
                retina_detect: true
            },
            midnight: {
                particles: {
                    number: { value: 35, density: { enable: true, value_area: 800 } },
                    color: { value: ['#b8c7e0', '#81a1c1', '#5e81ac', '#88c0d0'] },
                    shape: { type: 'circle' },
                    opacity: { value: 0.5, random: true, anim: { enable: false, speed: 1.5, opacity_min: 0.3, sync: false } },
                    size: { value: 3, random: true, anim: { enable: false, speed: 4, size_min: 1, sync: false } },
                    line_linked: { enable: true, distance: 160, color: '#b8c7e0', opacity: 0.35, width: 0.5 },
                    move: { enable: true, speed: 2.5, direction: 'none', random: true, straight: false, out_mode: 'bounce', bounce: true, attract: { enable: false, rotateX: 600, rotateY: 1200 } }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: {
                        onhover: { enable: false, mode: 'grab' },
                        onclick: { enable: false, mode: 'push' },
                        resize: true
                    },
                    modes: {
                        grab: { distance: 140, line_linked: { opacity: 1 } },
                        bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 },
                        repulse: { distance: 200, duration: 0.4 },
                        push: { particles_nb: 4 },
                        remove: { particles_nb: 2 }
                    }
                },
                retina_detect: true
            },
            rose: {
                particles: {
                    number: { value: 25, density: { enable: true, value_area: 800 } },
                    color: { value: ['#e0b8c7', '#f38ba8', '#eba0ac', '#f5c2e7'] },
                    shape: { type: 'circle' },
                    opacity: { value: 0.45, random: true, anim: { enable: false, speed: 1.2, opacity_min: 0.3, sync: false } },
                    size: { value: 2.8, random: true, anim: { enable: false, speed: 2.5, size_min: 1, sync: false } },
                    line_linked: { enable: true, distance: 200, color: '#e0b8c7', opacity: 0.3, width: 0.5 },
                    move: { enable: true, speed: 2.2, direction: 'none', random: true, straight: false, out_mode: 'bounce', bounce: true, attract: { enable: false, rotateX: 600, rotateY: 1200 } }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: {
                        onhover: { enable: false, mode: 'bubble' },
                        onclick: { enable: false, mode: 'push' },
                        resize: true
                    },
                    modes: {
                        grab: { distance: 140, line_linked: { opacity: 1 } },
                        bubble: { distance: 200, size: 40, duration: 2, opacity: 8, speed: 3 },
                        repulse: { distance: 200, duration: 0.4 },
                        push: { particles_nb: 4 },
                        remove: { particles_nb: 2 }
                    }
                },
                retina_detect: true
            },
            noir: {
                particles: {
                    number: { value: 20, density: { enable: true, value_area: 800 } },
                    color: { value: ['#e0e0e0', '#c0c0c0', '#a0a0a0', '#808080'] },
                    shape: { type: 'circle' },
                    opacity: { value: 0.35, random: true, anim: { enable: false, speed: 1, opacity_min: 0.2, sync: false } },
                    size: { value: 2.2, random: true, anim: { enable: false, speed: 3, size_min: 1, sync: false } },
                    line_linked: { enable: true, distance: 220, color: '#e0e0e0', opacity: 0.25, width: 0.5 },
                    move: { enable: true, speed: 1.8, direction: 'none', random: true, straight: false, out_mode: 'bounce', bounce: true, attract: { enable: false, rotateX: 600, rotateY: 1200 } }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: {
                        onhover: { enable: false, mode: 'repulse' },
                        onclick: { enable: false, mode: 'push' },
                        resize: true
                    },
                    modes: {
                        grab: { distance: 140, line_linked: { opacity: 1 } },
                        bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 },
                        repulse: { distance: 180, duration: 0.4 },
                        push: { particles_nb: 4 },
                        remove: { particles_nb: 2 }
                    }
                },
                retina_detect: true
            }
        };

        // Function to initialize loading particles with current theme
        function initializeLoadingParticles() {
            const currentTheme = localStorage.getItem('siteTheme') || 'moss';
            const config = loadingParticleConfigs[currentTheme];
            
            console.log('Initializing loading particles for theme:', currentTheme);
            console.log('ParticlesJS available:', typeof particlesJS !== 'undefined');
            console.log('Loading particles container exists:', !!document.getElementById('loading-particles-js'));
            
            if (typeof particlesJS !== 'undefined' && config) {
                try {
                    particlesJS('loading-particles-js', config);
                    console.log('Loading particles initialized successfully for theme:', currentTheme);
                } catch (error) {
                    console.error('Error initializing loading particles:', error);
                    createSimpleLoadingParticles();
                }
            } else {
                console.log('ParticlesJS not available or config not found for loading screen');
                createSimpleLoadingParticles();
            }
        }

        // Fallback function for loading particles
        function createSimpleLoadingParticles() {
            const container = document.getElementById('loading-particles-js');
            if (!container) {
                console.log('Loading particles container not found');
                return;
            }
            
            console.log('Creating simple loading particles as fallback');
            container.innerHTML = '';
            
            // Create simple animated dots for loading screen
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: absolute;
                    width: 3px;
                    height: 3px;
                    background: #b2c2a8;
                    border-radius: 50%;
                    opacity: 0.4;
                    animation: loading-float 4s ease-in-out infinite;
                    animation-delay: ${i * 0.2}s;
                `;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                container.appendChild(particle);
            }
            
            // Add CSS animation
            if (!document.querySelector('#loading-particles-style')) {
                const style = document.createElement('style');
                style.id = 'loading-particles-style';
                style.textContent = `
                    @keyframes loading-float {
                        0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0.4; }
                        50% { transform: translateY(-15px) translateX(8px); opacity: 0.8; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Initialize loading particles on page load with multiple attempts
        window.addEventListener('load', function() {
            setTimeout(initializeLoadingParticles, 100);
            setTimeout(initializeLoadingParticles, 500);
            setTimeout(initializeLoadingParticles, 1000);
        });

        // Also try on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeLoadingParticles, 100);
            setTimeout(initializeLoadingParticles, 500);
        });

        // Reinitialize loading particles when theme changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'siteTheme') {
                // Clean up existing loading particles
                if (typeof pJSDom !== 'undefined' && pJSDom && pJSDom.length > 1) {
                    if (pJSDom[1] && pJSDom[1].pJS && pJSDom[1].pJS.fn && pJSDom[1].pJS.fn.vendors) {
                        try {
                            pJSDom[1].pJS.fn.vendors.destroypJS();
                            pJSDom.splice(1, 1);
                        } catch (error) {
                            console.error('Error destroying loading particles:', error);
                        }
                    }
                }
                // Reinitialize with new theme
                setTimeout(initializeLoadingParticles, 100);
            }
        });

        // ===== URL SEARCH FUNCTIONALITY =====
        
        // Preload iframe for faster loading
        const proxyIframe = document.getElementById("proxyIframe");
        
        // Optimize iframe loading
        function optimizeIframeLoading() {
            // Set high priority for iframe
            proxyIframe.setAttribute('importance', 'high');
            
            // Preload common domains
            const commonDomains = [
                'https://www.google.com',
                'https://www.youtube.com',
                'https://www.github.com',
                'https://www.reddit.com',
                'https://www.twitter.com',
                'https://www.discord.com'
            ];
            
            // Preload DNS for common domains
            commonDomains.forEach(domain => {
                const link = document.createElement('link');
                link.rel = 'dns-prefetch';
                link.href = domain;
                document.head.appendChild(link);
            });
        }
        
        // Handle Enter key press in search bar with optimized loading
        document.getElementById("proxySearch").addEventListener("keypress", async function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                
                const input = event.target.value.trim();
                if (!input) return; // Don't process empty input

                // Check if user typed malachite:// protocol
                if (input.toLowerCase().startsWith("malachite://")) {
                    // Handle known malachite:// URLs
                    if (input.toLowerCase() === "malachite://home") {
                        showHomepage();
                        return;
                    }
                    
                    if (input.toLowerCase() === "malachite://settings") {
                        showSettingsPage();
                        return;
                    }
                    
                    // For any other malachite:// URL, show 404 page
                    show404Page();
                    return;
                }

                try {
                    // Show loading state
                    proxyIframe.style.opacity = '0.7';
                    
                    // Get the latest search engine URL from localStorage
                    const searchEngineUrl = localStorage.getItem('searchEngineSelectUrl') || "https://www.duckduckgo.com/?q=%s";
                    const proxyBackend = localStorage.getItem('proxyBackendSelect') || "uv";
                    
                    // Encode the URL using Chemical.js with selected backend
                    const encodedUrl = await chemical.encode(input, {
                        service: proxyBackend,
                        autoHttps: true,
                        searchEngine: searchEngineUrl
                    });

                    // Update current tab with the new URL
                    updateCurrentTab(encodedUrl, input);

                    // Store encoded URL for persistence
                    sessionStorage.setItem("encodedUrl", encodedUrl);

                    // Preload the URL before setting src
                    const preloadLink = document.createElement('link');
                    preloadLink.rel = 'preload';
                    preloadLink.as = 'document';
                    preloadLink.href = encodedUrl;
                    document.head.appendChild(preloadLink);

                    // Load the encoded URL in the iframe with optimized loading
                    proxyIframe.src = encodedUrl;
                    
                    // Remove preload link after a short delay
                    setTimeout(() => {
                        if (preloadLink.parentNode) {
                            preloadLink.parentNode.removeChild(preloadLink);
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error encoding URL:', error);
                    proxyIframe.style.opacity = '1';
                }
            }
        });

        // ===== CHEMICAL.JS LOADING DETECTION =====
        
        // Function to check if Chemical.js is fully loaded and ready
        function isChemicalReady() {
            return typeof chemical !== 'undefined' && 
                   typeof chemical.encode === 'function' && 
                   typeof chemical.setStore === 'function' &&
                   typeof chemical.componentAction === 'function';
        }
        
        // Function to hide loading screen
        function hideLoadingScreen() {
            const loadingScreen = document.querySelector('.loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                loadingScreen.style.visibility = 'hidden';
                // Don't show devtools here - wait for iframe to fully load
            }
        }
        
        // Function to show devtools after iframe is fully loaded
        function showDevToolsAfterIframeLoad() {
            console.log('Iframe fully loaded, waiting 0.1 seconds before showing Eruda devtools...');
            
            // Add a 0.1 second delay before showing devtools
            setTimeout(() => {
                console.log('Delay complete, now showing Eruda devtools...');
                showDevTools();
                
                // Also try to show devtools multiple times to ensure it appears
                setTimeout(showDevTools, 100);
                setTimeout(showDevTools, 200);
                setTimeout(showDevTools, 500);
            }, 100); // 0.1 second delay
        }
        
        // Track if iframe has loaded content
        let iframeHasLoaded = false;
        let chemicalIsReady = false;
        
        // ===== URL PERSISTENCE =====
        
        // Restore previous URL on page load and wait for both Chemical.js and iframe
        window.addEventListener('DOMContentLoaded', (event) => {
            // Optimize iframe loading immediately
            optimizeIframeLoading();
            
            const encodedUrl = sessionStorage.getItem("encodedUrl");
            if (encodedUrl) {
                // Preload the stored URL for faster loading
                const preloadLink = document.createElement('link');
                preloadLink.rel = 'preload';
                preloadLink.as = 'document';
                preloadLink.href = encodedUrl;
                document.head.appendChild(preloadLink);
                
                // Load the encoded URL in the iframe
                proxyIframe.src = encodedUrl;
                
                // Remove preload link after loading
                setTimeout(() => {
                    if (preloadLink.parentNode) {
                        preloadLink.parentNode.removeChild(preloadLink);
                    }
                }, 2000);
            }
            
            // Wait for Chemical.js to be ready
            function waitForChemical() {
                if (isChemicalReady()) {
                    console.log('Chemical.js is ready');
                    chemicalIsReady = true;
                    checkIfReadyToHide();
                } else {
                    console.log('Chemical.js not ready yet, checking again...');
                    setTimeout(waitForChemical, 100); // Check every 100ms
                }
            }
            
            // Check if both Chemical.js and iframe are ready
            function checkIfReadyToHide() {
                if (chemicalIsReady && iframeHasLoaded) {
                    console.log('Both Chemical.js and iframe are ready, hiding loading screen');
                    hideLoadingScreen();
                    // Show devtools after iframe is fully loaded
                    showDevToolsAfterIframeLoad();
                } else if (chemicalIsReady && !iframeHasLoaded) {
                    console.log('Chemical.js ready but waiting for iframe to load...');
                } else if (!chemicalIsReady && iframeHasLoaded) {
                    console.log('Iframe loaded but waiting for Chemical.js...');
                }
            }
            
            // Start checking for Chemical.js readiness
            setTimeout(waitForChemical, 500); // Start checking after 500ms
        });

        // ===== SEARCH ENGINE CONFIGURATION =====
        
        // ===== LOADING SCREEN MANAGEMENT =====
        
        // Hide loading screen when iframe loads (but only if both Chemical.js and iframe are ready)
        proxyIframe.addEventListener('load', function() {
            console.log('Iframe has loaded content');
            
            // Add loaded class to iframe for smooth fade-in
            this.classList.add('loaded');
            
            // Restore full opacity
            this.style.opacity = '1';
            
            // Update current tab with the loaded URL
            if (activeTabId) {
                const currentUrl = this.src;
                updateCurrentTab(currentUrl);
                
                // Try to get the page title from the iframe
                try {
                    const iframeTitle = this.contentDocument?.title || this.contentWindow?.document?.title;
                    if (iframeTitle && iframeTitle !== 'about:blank') {
                        const tab = tabs.find(t => t.id === activeTabId);
                        if (tab) {
                            tab.title = iframeTitle;
                            const tabElement = document.querySelector(`[data-tab-id="${activeTabId}"]`);
                            if (tabElement) {
                                const titleElement = tabElement.querySelector('.tab-title');
                                if (titleElement) {
                                    titleElement.textContent = iframeTitle;
                                }
                            }
                        }
                    }
                } catch (error) {
                    // Cross-origin restrictions might prevent accessing iframe content
                    console.log('Could not access iframe title due to cross-origin restrictions');
                }
            }
            
            // Mark iframe as loaded
            iframeHasLoaded = true;
            
            // Check if both Chemical.js and iframe are ready
            if (chemicalIsReady) {
                console.log('Both Chemical.js and iframe are ready, hiding loading screen');
                setTimeout(() => {
                    hideLoadingScreen();
                    // Show devtools after iframe is fully loaded
                    showDevToolsAfterIframeLoad();
                }, 300); // Small delay for smooth transition
            } else {
                console.log('Iframe loaded but waiting for Chemical.js...');
            }
        });
        
        // Add error handling for iframe loading
        proxyIframe.addEventListener('error', function() {
            console.error('Iframe failed to load');
            this.style.opacity = '1';
        });
        
        // ===== FULLSCREEN FUNCTIONALITY =====
        
        // Toggle fullscreen mode for the iframe
        function toggleFullscreen() {
            const iframe = document.getElementById('proxyIframe');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            const navbar = document.getElementById('navbar');
            
            if (!document.fullscreenElement) {
                // Enter fullscreen
                if (iframe.requestFullscreen) {
                    iframe.requestFullscreen();
                } else if (iframe.webkitRequestFullscreen) {
                    iframe.webkitRequestFullscreen();
                } else if (iframe.msRequestFullscreen) {
                    iframe.msRequestFullscreen();
                }
                
                // Update icon and button state
                fullscreenIcon.className = 'fa-solid fa-compress';
                fullscreenBtn.classList.add('active');
                
                // Hide navbar in fullscreen
                navbar.style.display = 'none';
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                // Update icon and button state
                fullscreenIcon.className = 'fa-solid fa-expand';
                fullscreenBtn.classList.remove('active');
                
                // Show navbar when exiting fullscreen
                navbar.style.display = 'flex';
            }
        }
        
        // Listen for fullscreen change events to update UI
        document.addEventListener('fullscreenchange', updateFullscreenUI);
        document.addEventListener('webkitfullscreenchange', updateFullscreenUI);
        document.addEventListener('mozfullscreenchange', updateFullscreenUI);
        document.addEventListener('MSFullscreenChange', updateFullscreenUI);
        
        function updateFullscreenUI() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            const navbar = document.getElementById('navbar');
            
            if (document.fullscreenElement) {
                fullscreenIcon.className = 'fa-solid fa-compress';
                fullscreenBtn.classList.add('active');
                navbar.style.display = 'none';
            } else {
                fullscreenIcon.className = 'fa-solid fa-expand';
                fullscreenBtn.classList.remove('active');
                navbar.style.display = 'flex';
            }
        }
        
        // ===== TAB MANAGEMENT =====
        
        // Tab state management
        let tabs = [];
        let activeTabId = null;
        let nextTabId = 1;
        
        // Initialize tabs
        function initializeTabs() {
            console.log('Initializing tabs...');
            console.log('Current tabs array:', tabs);
            
            // Create initial tab if none exist
            if (tabs.length === 0) {
                console.log('No tabs exist, creating initial tab...');
                addNewTab();
                showHomepage(); // Show homepage for initial tab
            }
            
            // Update tab display
            updateTabDisplay();
            
            // Set up iframe event listeners
            setupIframeListeners();
            
            console.log('Tabs initialization complete. Total tabs:', tabs.length);
        }
        
        // Add a new tab
        function addNewTab(url = null, title = "New Tab") {
            console.log('Adding new tab with title:', title, 'URL:', url);
            
            const tabId = 'tab-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            tabs.push({
                id: tabId,
                url: url || "about:blank",
                title: title,
                favicon: null
            });
            
            activeTabId = tabId;
            
            // Create tab element
            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.setAttribute('data-tab-id', tabId);
            tabElement.innerHTML = `
                <span class="tab-title">${title}</span>
                <button class="tab-close" onclick="closeTab('${tabId}')">×</button>
            `;
            
            tabElement.addEventListener('click', () => switchTab(tabId));
            
            // Insert into tabs container
            const tabsContainer = document.getElementById('tabs-container');
            if (tabsContainer) {
                tabsContainer.appendChild(tabElement);
                console.log('Tab element added to DOM');
            } else {
                console.error('Tabs container not found!');
            }
            
            // Update iframe and show homepage for new tabs
            const iframe = document.getElementById('proxyIframe');
            if (iframe) {
                if (url && url !== "about:blank" && url !== null && url !== "malachite://home") {
                    // If a specific URL is provided (but not malachite://home), load it and hide homepage
                    iframe.src = url;
                    hideHomepage();
                    console.log('Loading specific URL:', url);
                    
                    // Update search bar with the URL
                    const searchInput = document.getElementById('proxySearch');
                    if (searchInput) {
                        searchInput.value = url;
                    }
                } else {
                    // For new tabs (no URL, about:blank, or malachite://home), show homepage
                    showHomepage();
                    console.log('Showing homepage for new tab');
                }
            }
            
            updateTabDisplay();
            console.log('New tab created with ID:', tabId);
            return tabId;
        }
        
        // Switch to a specific tab
        function switchTab(tabId) {
            const tab = tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            console.log('Switching to tab:', tabId, 'URL:', tab.url);
            activeTabId = tabId;
            
            // Update iframe
            const iframe = document.getElementById('proxyIframe');
            if (iframe) {
                if (tab.url && tab.url !== "about:blank" && tab.url !== "malachite://home") {
                    // If tab has a real URL, load it and hide homepage
                    iframe.src = tab.url;
                    hideHomepage();
                    console.log('Loading tab URL:', tab.url);
                    
                    // Update search bar with the URL
                    const searchInput = document.getElementById('proxySearch');
                    if (searchInput) {
                        searchInput.value = tab.url;
                    }
                } else {
                    // If tab is blank or homepage, show homepage
                    showHomepage();
                    console.log('Showing homepage for tab');
                }
            }
            
            updateTabDisplay();
        }
        
        // Close a tab
        function closeTab(tabId) {
            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;
            
            // Don't allow closing the last tab if it's the only one
            if (tabs.length === 1) {
                console.log('Cannot close the last tab - creating a new home tab');
                // Create a new home tab to replace the one being closed
                const newTabId = addNewTab("malachite://home", "Home");
                // Close the original tab
                tabs.splice(tabIndex, 1);
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (tabElement) {
                    tabElement.remove();
                }
                // Switch to the new tab
                switchTab(newTabId);
                updateTabDisplay();
                return;
            }
            
            // Remove tab from array
            tabs.splice(tabIndex, 1);
            
            // Remove tab element from DOM
            const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
            if (tabElement) {
                tabElement.remove();
            }
            
            // If we closed the active tab, switch to another tab
            if (activeTabId === tabId) {
                if (tabs.length > 0) {
                    // Switch to the next tab, or the previous one if we closed the last tab
                    const newTabIndex = tabIndex >= tabs.length ? tabIndex - 1 : tabIndex;
                    switchTab(tabs[newTabIndex].id);
                } else {
                    // This shouldn't happen now, but just in case, create a new home tab
                    addNewTab("malachite://home", "Home");
                }
            }
            
            updateTabDisplay();
        }
        
        // Update tab display
        function updateTabDisplay() {
            // Update active tab styling
            document.querySelectorAll('.tab').forEach(tabElement => {
                const tabId = tabElement.getAttribute('data-tab-id');
                if (tabId === activeTabId) {
                    tabElement.classList.add('active');
                } else {
                    tabElement.classList.remove('active');
                }
            });
            
            // Always show tab bar - don't hide it
            const tabBar = document.getElementById('tab-bar');
            if (tabBar) {
                tabBar.style.display = 'flex';
            }
        }
        
        // Update current tab with new URL and title
        function updateCurrentTab(url, title) {
            const currentTab = tabs.find(t => t.id === activeTabId);
            if (currentTab) {
                currentTab.url = url;
                currentTab.title = title;
                
                // Update tab element
                const tabElement = document.querySelector(`[data-tab-id="${activeTabId}"]`);
                if (tabElement) {
                    const titleElement = tabElement.querySelector('.tab-title');
                    if (titleElement) {
                        titleElement.textContent = title;
                    }
                }
                
                // Hide homepage when updating with a real URL (but not malachite://home)
                if (url && url !== "about:blank" && url !== "malachite://home") {
                    hideHomepage();
                }
            }
        }
        
        // Initialize tabs when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded event fired - initializing tabs');
            initializeTabs();
            
            // Handle Enter key in homepage search
            const homepageSearch = document.getElementById('homepage-search');
            if (homepageSearch) {
                homepageSearch.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        searchFromHomepage();
                    }
                });
            }
        });
        
        // Fallback initialization
        window.addEventListener('load', () => {
            console.log('Window load event fired - checking tabs');
            if (tabs.length === 0) {
                console.log('No tabs found on window load, initializing...');
                initializeTabs();
            }
        });
        
        // Immediate initialization if DOM is already ready
        if (document.readyState === 'loading') {
            console.log('Document still loading, waiting for DOMContentLoaded');
        } else {
            console.log('Document already ready, initializing tabs immediately');
            initializeTabs();
        }
        
        // ===== HOMEPAGE FUNCTIONALITY =====
        
        // Show homepage
        function showHomepage() {
            const iframe = document.getElementById('proxyIframe');
            
            if (iframe) {
                // Load the separate malachite home page
                iframe.src = '/malachite-home.html';
                
                // Update current tab title to show "Home" and search bar to show "malachite://home"
                if (activeTabId) {
                    updateCurrentTab("malachite://home", "Home");
                    
                    // Update search bar to show malachite://home
                    const searchInput = document.getElementById('proxySearch');
                    if (searchInput) {
                        searchInput.value = "malachite://home";
                    }
                }
                
                // Show iframe and hide homepage overlay
                iframe.style.display = 'block';
                const homepage = document.getElementById('homepage-overlay');
                if (homepage) {
                    homepage.style.display = 'none';
                }
            }
        }
        
        // Show 404 page
        function show404Page() {
            const iframe = document.getElementById('proxyIframe');
            
            if (iframe) {
                // Get the malachite:// URL that caused the 404
                const searchInput = document.getElementById('proxySearch');
                const malachiteUrl = searchInput ? searchInput.value.trim() : 'malachite://unknown';
                
                console.log('404 Page - Malachite URL:', malachiteUrl); // Debug log
                
                // Load the proxy-specific 404 page with the URL as a parameter
                iframe.src = `/404-proxy.html?url=${encodeURIComponent(malachiteUrl)}`;
                
                // Update current tab title to show "404" and search bar to show the malachite:// URL
                if (activeTabId) {
                    updateCurrentTab("malachite://404", "404 - Malachite Protocol Error");
                    
                    // Keep the malachite:// URL in the search bar with a delay to ensure it persists
                    if (searchInput && malachiteUrl) {
                        setTimeout(() => {
                            searchInput.value = malachiteUrl;
                            console.log('404 Page - Set search input to:', malachiteUrl); // Debug log
                        }, 100);
                    }
                }
                
                // Show iframe and hide homepage
                iframe.style.display = 'block';
                const homepage = document.getElementById('homepage-overlay');
                if (homepage) {
                    homepage.style.display = 'none';
                }
            }
        }
        
        // Show settings page
        function showSettingsPage() {
            const iframe = document.getElementById('proxyIframe');
            
            if (iframe) {
                // Load the proxy settings page
                iframe.src = '/settings-proxy.html';
                
                // Update current tab title to show "Settings" and search bar to show the malachite:// URL
                if (activeTabId) {
                    updateCurrentTab("malachite://settings", "Settings");
                    
                    // Keep the malachite://settings URL in the search bar
                    const searchInput = document.getElementById('proxySearch');
                    if (searchInput) {
                        searchInput.value = "malachite://settings";
                    }
                }
                
                // Show iframe and hide homepage
                iframe.style.display = 'block';
                const homepage = document.getElementById('homepage-overlay');
                if (homepage) {
                    homepage.style.display = 'none';
                }
                
                // Set a flag to remember we're on settings page
                localStorage.setItem('currentProxyPage', 'malachite://settings');
            }
        }
        
        // Open current proxied URL in about:blank tab
        function openInNewTab() {
            const iframe = document.getElementById('proxyIframe');
            const searchInput = document.getElementById('proxySearch');
            
            if (iframe && iframe.src && iframe.src !== 'about:blank') {
                // Get the current URL from the iframe
                const currentUrl = iframe.src;
                
                // Don't open special pages (home, settings, 404) in new tab
                if (currentUrl.includes('malachite-home.html') || 
                    currentUrl.includes('settings-proxy.html') || 
                    currentUrl.includes('404-proxy.html')) {
                    console.log('Cannot open special page in new tab');
                    return;
                }
                
                // Open in about:blank (same as settings launchab function)
                const tab = window.open('about:blank', '_blank');
                const iframe_new = tab.document.createElement('iframe');
                const stl = iframe_new.style;
                stl.border = stl.outline = 'none';
                stl.width = '100vw';
                stl.height = '100vh';
                stl.position = 'fixed';
                stl.left = stl.right = stl.top = stl.bottom = '0';
                iframe_new.src = currentUrl;
                tab.document.body.appendChild(iframe_new);
                
            } else if (searchInput && searchInput.value && !searchInput.value.startsWith('malachite://')) {
                // If iframe is not loaded but we have a URL in search bar, try to open that
                const tab = window.open('about:blank', '_blank');
                const iframe_new = tab.document.createElement('iframe');
                const stl = iframe_new.style;
                stl.border = stl.outline = 'none';
                stl.width = '100vw';
                stl.height = '100vh';
                stl.position = 'fixed';
                stl.left = stl.right = stl.top = stl.bottom = '0';
                iframe_new.src = searchInput.value;
                tab.document.body.appendChild(iframe_new);
            } else {
                console.log('No valid URL to open in new tab');
            }
        }
        
        // Apply cloak to proxy page
        function applyCloakToProxy(option) {
            console.log('Applying cloak to proxy page:', option);
            
            // Try to apply cloak using chemical library
            if (typeof chemical !== 'undefined' && chemical.setStore) {
                console.log('Chemical library found, applying cloak to proxy...');
                if (option === 'Google') {
                    chemical.setStore('title', 'Google');
                    chemical.setStore('icon', 'img/google.ico');
                } else if (option === 'Gmail') {
                    chemical.setStore('title', 'Gmail');
                    chemical.setStore('icon', 'img/gmail.ico');
                } else if (option === 'Google Drive') {
                    chemical.setStore('title', 'My Drive - Google Drive');
                    chemical.setStore('icon', 'img/drive.png');
                } else if (option === 'Schoology') {
                    chemical.setStore('title', 'Home | Schoology');
                    chemical.setStore('icon', 'img/schoology.ico');
                } else if (option === 'iReady') {
                    chemical.setStore('title', 'i-Ready Dashboard');
                    chemical.setStore('icon', 'img/iready.ico');
                } else if (option === 'Clever') {
                    chemical.setStore('title', 'Clever | Portal');
                    chemical.setStore('icon', 'img/clever.ico');
                } else {
                    chemical.setStore('title', 'Malachite');
                    chemical.setStore('icon', 'img/favicon.ico');
                }
                console.log('Cloak applied to proxy via chemical library');
            } else {
                console.log('Chemical library not available for proxy page');
            }
        }
        
        // Hide homepage (no longer needed since we use iframe)
        function hideHomepage() {
            // This function is kept for compatibility but no longer needed
            // The iframe is always visible when showing the home page
        }
        
        // Search from homepage
        async function searchFromHomepage() {
            // Get the search input from the iframe content
            const iframe = document.getElementById('proxyIframe');
            if (!iframe || !iframe.contentDocument) return;
            
            const searchInput = iframe.contentDocument.getElementById('search');
            if (!searchInput) return;
            
            const input = searchInput.value.trim();
            if (!input) return;
            
            try {
                // Get the latest search engine URL and proxy backend from localStorage
                const searchEngineUrl = localStorage.getItem('searchEngineSelectUrl') || "https://www.duckduckgo.com/?q=%s";
                const proxyBackend = localStorage.getItem('proxyBackendSelect') || "uv";
                
                // Encode the URL using Chemical.js with selected backend
                const encodedUrl = await chemical.encode(input, {
                    service: proxyBackend,
                    autoHttps: true,
                    searchEngine: searchEngineUrl
                });
                
                // Update current tab with the new URL
                updateCurrentTab(encodedUrl, input);
                
                // Load the URL in the iframe
                iframe.src = encodedUrl;
                
            } catch (error) {
                console.error('Error encoding URL from homepage:', error);
            }
        }
        
        // Open quick link
        async function openQuickLink(url) {
            try {
                const proxyBackend = localStorage.getItem('proxyBackendSelect') || "uv";
                
                // Encode the URL
                const encodedUrl = await chemical.encode(url, {
                    service: proxyBackend,
                    autoHttps: true
                });
                
                // Update current tab
                updateCurrentTab(encodedUrl, getDomainFromUrl(url));
                
                // Hide homepage and show iframe
                hideHomepage();
                
                // Load the URL in the iframe
                const iframe = document.getElementById('proxyIframe');
                iframe.src = encodedUrl;
                
            } catch (error) {
                console.error('Error opening quick link:', error);
            }
        }
        
        // Get domain from URL
        function getDomainFromUrl(url) {
            try {
                const domain = new URL(url).hostname.replace('www.', '');
                return domain.charAt(0).toUpperCase() + domain.slice(1);
            } catch {
                return 'Unknown Site';
            }
        }
        
        // Set up iframe event listeners
        function setupIframeListeners() {
            const iframe = document.getElementById('proxyIframe');
            if (iframe) {
                // Show loading screen initially
                iframe.style.opacity = '0';
                
                // Handle iframe load events
                iframe.addEventListener('load', () => {
                    // Hide loading screen
                    const loadingScreen = document.querySelector('.loading-screen');
                    if (loadingScreen) {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.visibility = 'hidden';
                        }, 500);
                    }
                    
                    // Show iframe
                    iframe.style.opacity = '1';
                    iframe.classList.add('loaded');
                    
                    // Update tab title from iframe (but not for 404 pages)
                    if (!iframe.src.includes('404-proxy.html')) {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const iframeTitle = iframeDoc.title;
                            if (iframeTitle && iframeTitle !== '') {
                                updateCurrentTab(iframe.src, iframeTitle);
                            }
                        } catch (e) {
                            // Cross-origin restrictions, can't access iframe content
                            console.log('Cannot access iframe content due to CORS');
                        }
                    }
                });
                
                // Handle iframe errors
                iframe.addEventListener('error', () => {
                    console.error('Iframe failed to load');
                    // Hide loading screen even on error
                    const loadingScreen = document.querySelector('.loading-screen');
                    if (loadingScreen) {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.visibility = 'hidden';
                        }, 500);
                    }
                });
            }
        }
        
        // Handle messages from iframe (for 404 page navigation and theme changes)
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type) {
                switch (event.data.type) {
                    case 'malachite-navigate':
                        if (event.data.url === 'malachite://home') {
                            showHomepage();
                        } else if (event.data.url === 'malachite://back') {
                            // Go back to the previous page or homepage
                            const searchInput = document.getElementById('proxySearch');
                            if (searchInput && searchInput.value.trim() !== 'malachite://settings') {
                                // If there was a previous URL, go back to it
                                showHomepage();
                            } else {
                                // Otherwise go to homepage
                                showHomepage();
                            }
                        }
                        break;
                    case 'theme-change':
                        // Handle theme changes from settings page
                        if (event.data.theme) {
                            console.log('Theme change received from settings:', event.data.theme);
                            // Apply theme to proxy page
                            document.body.classList.remove('theme-moss', 'theme-midnight', 'theme-rose', 'theme-noir');
                            document.body.classList.add('theme-' + event.data.theme);
                            localStorage.setItem('siteTheme', event.data.theme);
                            
                            // Reinitialize particles with new theme
                            setTimeout(() => {
                                if (typeof initializeParticles === 'function') {
                                    initializeParticles();
                                }
                            }, 100);
                        }
                        break;
                    case 'apply-cloak':
                        // Handle tab cloaking from settings page
                        if (event.data.option) {
                            console.log('Cloak change received from settings:', event.data.option);
                            applyCloakToProxy(event.data.option);
                        }
                        break;
                }
            }
        });
    </script>
    
    <!-- External Scripts -->
    		<script src="js/particles.min.js"></script>
		<script src="js/main.js" defer></script>
		<script src="js/proxypage.js"></script>
		<script src="js/transitions.js" defer></script>
    <script>
        // Test if particles.js loaded
        console.log('Particles.js loaded:', typeof particlesJS !== 'undefined');
        console.log('Particles container exists:', !!document.getElementById('particles-js'));
    </script>	
	<script>
		// Theme-based particle configurations
		const particleConfigs = {
			moss: {
				particles: {
					number: { value: 40, density: { enable: true, value_area: 800 } },
					color: { value: ['#b2c2a8', '#94e2d5', '#a6e3a1', '#89dceb'] },
					shape: { type: 'circle' },
					opacity: { value: 0.3, random: true, anim: { enable: false, speed: 1, opacity_min: 0.1, sync: false } },
					size: { value: 2, random: true, anim: { enable: false, speed: 2, size_min: 1, sync: false } },
					line_linked: { enable: true, distance: 200, color: '#b2c2a8', opacity: 0.2, width: 0.5 },
					move: { enable: true, speed: 1.5, direction: 'none', random: true, straight: false, out_mode: 'bounce', bounce: true, attract: { enable: false, rotateX: 600, rotateY: 1200 } }
				},
				interactivity: {
					detect_on: 'canvas',
					events: {
						onhover: { enable: false, mode: 'repulse' },
						onclick: { enable: false, mode: 'push' },
						resize: true
					},
					modes: {
						grab: { distance: 140, line_linked: { opacity: 1 } },
						bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 },
						repulse: { distance: 150, duration: 0.4 },
						push: { particles_nb: 4 },
						remove: { particles_nb: 2 }
					}
				},
				retina_detect: true
			},
			midnight: {
				particles: {
					number: { value: 50, density: { enable: true, value_area: 800 } },
					color: { value: ['#b8c7e0', '#81a1c1', '#5e81ac', '#88c0d0'] },
					shape: { type: 'circle' },
					opacity: { value: 0.4, random: true, anim: { enable: false, speed: 1.5, opacity_min: 0.2, sync: false } },
					size: { value: 2.5, random: true, anim: { enable: false, speed: 4, size_min: 1, sync: false } },
					line_linked: { enable: true, distance: 180, color: '#b8c7e0', opacity: 0.25, width: 0.5 },
					move: { enable: true, speed: 2, direction: 'none', random: true, straight: false, out_mode: 'bounce', bounce: true, attract: { enable: false, rotateX: 600, rotateY: 1200 } }
				},
				interactivity: {
					detect_on: 'canvas',
					events: {
						onhover: { enable: false, mode: 'grab' },
						onclick: { enable: false, mode: 'push' },
						resize: true
					},
					modes: {
						grab: { distance: 140, line_linked: { opacity: 1 } },
						bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 },
						repulse: { distance: 200, duration: 0.4 },
						push: { particles_nb: 4 },
						remove: { particles_nb: 2 }
					}
				},
				retina_detect: true
			},
			rose: {
				particles: {
					number: { value: 35, density: { enable: true, value_area: 800 } },
					color: { value: ['#e0b8c7', '#f38ba8', '#eba0ac', '#f5c2e7'] },
					shape: { type: 'circle' },
					opacity: { value: 0.35, random: true, anim: { enable: false, speed: 1.2, opacity_min: 0.2, sync: false } },
					size: { value: 2.2, random: true, anim: { enable: false, speed: 2.5, size_min: 1, sync: false } },
					line_linked: { enable: true, distance: 220, color: '#e0b8c7', opacity: 0.2, width: 0.5 },
					move: { enable: true, speed: 1.8, direction: 'none', random: true, straight: false, out_mode: 'bounce', bounce: true, attract: { enable: false, rotateX: 600, rotateY: 1200 } }
				},
				interactivity: {
					detect_on: 'canvas',
					events: {
						onhover: { enable: false, mode: 'bubble' },
						onclick: { enable: false, mode: 'push' },
						resize: true
					},
					modes: {
						grab: { distance: 140, line_linked: { opacity: 1 } },
						bubble: { distance: 200, size: 40, duration: 2, opacity: 8, speed: 3 },
						repulse: { distance: 200, duration: 0.4 },
						push: { particles_nb: 4 },
						remove: { particles_nb: 2 }
					}
				},
				retina_detect: true
			},
			noir: {
				particles: {
					number: { value: 30, density: { enable: true, value_area: 800 } },
					color: { value: ['#e0e0e0', '#c0c0c0', '#a0a0a0', '#808080'] },
					shape: { type: 'circle' },
					opacity: { value: 0.25, random: true, anim: { enable: false, speed: 1, opacity_min: 0.1, sync: false } },
					size: { value: 1.8, random: true, anim: { enable: false, speed: 3, size_min: 1, sync: false } },
					line_linked: { enable: true, distance: 250, color: '#e0e0e0', opacity: 0.15, width: 0.5 },
					move: { enable: true, speed: 1.2, direction: 'none', random: true, straight: false, out_mode: 'bounce', bounce: true, attract: { enable: false, rotateX: 600, rotateY: 1200 } }
				},
				interactivity: {
					detect_on: 'canvas',
					events: {
						onhover: { enable: false, mode: 'repulse' },
						onclick: { enable: false, mode: 'push' },
						resize: true
					},
					modes: {
						grab: { distance: 140, line_linked: { opacity: 1 } },
						bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 },
						repulse: { distance: 180, duration: 0.4 },
						push: { particles_nb: 4 },
						remove: { particles_nb: 2 }
					}
				},
				retina_detect: true
			}
		};

		// Function to initialize particles with current theme
		function initializeParticles() {
			const currentTheme = localStorage.getItem('siteTheme') || 'moss';
			const config = particleConfigs[currentTheme];
			
			console.log('Initializing particles for theme:', currentTheme);
			console.log('ParticlesJS available:', typeof particlesJS !== 'undefined');
			console.log('Config available:', !!config);
			
			// Ensure pJSDom is properly initialized
			if (typeof pJSDom === 'undefined' || pJSDom === null) {
				window.pJSDom = [];
			}
			
			if (typeof particlesJS !== 'undefined' && config) {
				try {
					particlesJS('particles-js', config);
					console.log('Particles initialized successfully for theme:', currentTheme);
				} catch (error) {
					console.error('Error initializing particles:', error);
					// Fallback: create simple particles manually
					createSimpleParticles();
				}
			} else {
				console.log('ParticlesJS not available or config not found');
				// Fallback: create simple particles manually
				createSimpleParticles();
			}
		}

		// Fallback function to create simple particles
		function createSimpleParticles() {
			const container = document.getElementById('particles-js');
			if (!container) {
				console.log('Particles container not found');
				return;
			}
			
			console.log('Creating simple particles as fallback');
			container.innerHTML = '';
			
			// Create simple animated dots
			for (let i = 0; i < 20; i++) {
				const particle = document.createElement('div');
				particle.style.cssText = `
					position: absolute;
					width: 4px;
					height: 4px;
					background: #b2c2a8;
					border-radius: 50%;
					opacity: 0.3;
					animation: float 3s ease-in-out infinite;
					animation-delay: ${i * 0.1}s;
				`;
				particle.style.left = Math.random() * 100 + '%';
				particle.style.top = Math.random() * 100 + '%';
				container.appendChild(particle);
			}
			
			// Add CSS animation
			if (!document.querySelector('#simple-particles-style')) {
				const style = document.createElement('style');
				style.id = 'simple-particles-style';
				style.textContent = `
					@keyframes float {
						0%, 100% { transform: translateY(0px) translateX(0px); }
						50% { transform: translateY(-20px) translateX(10px); }
					}
				`;
				document.head.appendChild(style);
			}
		}

		// Initialize particles on page load with multiple attempts
		window.addEventListener('load', function() {
			setTimeout(initializeParticles, 100);
			setTimeout(initializeParticles, 500);
			setTimeout(initializeParticles, 1000);
		});

		// Also try on DOMContentLoaded
		document.addEventListener('DOMContentLoaded', function() {
			setTimeout(initializeParticles, 100);
			setTimeout(initializeParticles, 500);
		});

		// Reinitialize particles when theme changes
		window.addEventListener('storage', function(e) {
			if (e.key === 'siteTheme') {
				// Clean up existing particles
				if (typeof pJSDom !== 'undefined' && pJSDom && pJSDom.length > 0) {
					if (pJSDom[0] && pJSDom[0].pJS && pJSDom[0].pJS.fn && pJSDom[0].pJS.fn.vendors) {
						try {
							pJSDom[0].pJS.fn.vendors.destroypJS();
						} catch (error) {
							console.error('Error destroying particles:', error);
						}
					}
				}
				// Reset pJSDom array properly
				window.pJSDom = [];
				// Reinitialize with new theme
				setTimeout(initializeParticles, 100);
			}
		});
	</script>
	
	<script>
		        // Welcome back tracking functionality
        function checkWelcomeBack() {
            const lastVisit = localStorage.getItem('lastVisit');
            const currentTime = Date.now();
            const userName = localStorage.getItem('userName');
            
            // Update last visit time when user returns to proxy
            // This prevents the "offline" status when user is actually on the proxy page
            if (userName) {
                localStorage.setItem('lastVisit', currentTime.toString());
            }
        }
        
        // Restore correct URL when returning to proxy
        function restoreProxyURL() {
            const currentPage = localStorage.getItem('currentProxyPage');
            const searchInput = document.getElementById('proxySearch');
            
            if (currentPage && searchInput) {
                // Check if we're currently on a special page
                const iframe = document.getElementById('proxyIframe');
                if (iframe && iframe.src) {
                    if (iframe.src.includes('settings-proxy.html') && currentPage === 'malachite://settings') {
                        searchInput.value = "malachite://settings";
                    } else if (iframe.src.includes('404-proxy.html')) {
                        // For 404 pages, keep the malachite URL that caused the 404
                        const urlParams = new URLSearchParams(window.location.search);
                        const malachiteUrl = urlParams.get('url') || 'malachite://unknown';
                        searchInput.value = malachiteUrl;
                    }
                }
            }
        }
		
		// Track when user leaves the site
		function trackSiteLeave() {
			localStorage.setItem('lastVisit', Date.now().toString());
		}
		
		// Listen for when user leaves the site
		window.addEventListener('beforeunload', trackSiteLeave);
		window.addEventListener('pagehide', trackSiteLeave);
		
		        // Check welcome back when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Small delay to ensure everything is ready
            setTimeout(() => {
                checkWelcomeBack();
                restoreProxyURL();
                initializeHomepage();
            }, 100);
        });
        
        // Restore URL when page becomes visible again
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(() => {
                    restoreProxyURL();
                }, 100);
            }
        });
        
        // Initialize homepage functionality
        function initializeHomepage() {
            // Initialize clock and greeting
            updateProxyClock();
            updateProxyGreeting();
            
            // Start clock updates
            setInterval(updateProxyClock, 1000);
            
            // Initialize latency and FPS
            initializeProxyLatency();
            initializeProxyFPS();
            
            // Trigger slide-in animations
            triggerProxySlideInAnimations();
            
            // Set random placeholder
            setRandomProxyPlaceholder();
            
            // Add event listener for Enter key on homepage search
            const homepageSearch = document.getElementById('homepage-search');
            if (homepageSearch) {
                homepageSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchFromHomepage();
                    }
                });
            }
        }
        
        // Clock functionality
        function updateProxyClock() {
            const now = new Date();
            const timeElement = document.getElementById('proxy-main-time');
            const dateElement = document.getElementById('proxy-main-date');
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
            }
            
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        }
        
        // Greeting functionality
        function updateProxyGreeting() {
            const greetingElement = document.getElementById('proxy-main-greeting');
            if (!greetingElement) return;
            
            const userName = localStorage.getItem('userName') || 'there';
            const hour = new Date().getHours();
            let greeting = '';
            
            if (hour < 12) {
                greeting = `Good morning, ${userName}!`;
            } else if (hour < 18) {
                greeting = `Good afternoon, ${userName}!`;
            } else {
                greeting = `Good evening, ${userName}!`;
            }
            
            greetingElement.textContent = greeting;
        }
        
        // Latency functionality
        function initializeProxyLatency() {
            const latencySpan = document.getElementById("proxy-latency-value");
            if (!latencySpan) return;
            
            async function checkLatency() {
                const url = window.location.href;
                const start = performance.now();
                
                try {
                    await fetch(url, { method: "HEAD", cache: "no-store" });
                    const end = performance.now();
                    const latency = Math.round(end - start);
                    latencySpan.textContent = `${latency} ms`;
                } catch (e) {
                    latencySpan.textContent = "offline";
                }
            }
            
            setInterval(checkLatency, 1000);
            checkLatency();
        }
        
        // FPS functionality
        function initializeProxyFPS() {
            const fpsSpan = document.getElementById("proxy-fps-value");
            if (!fpsSpan) return;
            
            let lastTime = performance.now();
            let frameCount = 0;
            let fps = 0;
            
            function updateFPS() {
                const now = performance.now();
                frameCount++;
                
                if (now - lastTime >= 1000) {
                    fps = frameCount;
                    fpsSpan.textContent = fps;
                    frameCount = 0;
                    lastTime = now;
                }
                
                requestAnimationFrame(updateFPS);
            }
            
            requestAnimationFrame(updateFPS);
        }
        
        // Slide-in animations
        function triggerProxySlideInAnimations() {
            const slideElements = document.querySelectorAll('.slide-in-element');
            slideElements.forEach((element, index) => {
                setTimeout(() => {
                    element.classList.add('animate');
                }, index * 200);
            });
        }
        
        // Random placeholder
        function setRandomProxyPlaceholder() {
            const placeholderTexts = [
                "Search or Enter a URL...",
                "teacher i swear im doing my work",
                "hello there",
                "Better than doge!",
                "phoenix on top!"
            ];
            
            const randomPlaceholder = placeholderTexts[Math.floor(Math.random() * placeholderTexts.length)];
            const searchInput = document.getElementById('homepage-search');
            if (searchInput) {
                searchInput.placeholder = randomPlaceholder;
            }
        }
        
        // Listen for messages from iframe content (for search functionality)
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'malachite-search') {
                const input = event.data.query;
                if (input && input.trim()) {
                    searchFromHomepage();
                }
            }
        });
	</script>
</body>
</html>